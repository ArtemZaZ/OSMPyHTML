<!DOCTYPE html>
<html>
  <head>
    <title>GPX Data</title>
    <link rel="stylesheet" href="https://openlayers.org/en/v4.6.5/css/ol.css" type="text/css">
    <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
    <script src="https://openlayers.org/en/v4.6.5/build/ol.js"></script>
  </head>
  <body>
    <div id="map" class="map"></div>
    <script>
      // слой карты + стили линий
      var raster = new ol.layer.Tile({
        source: new ol.source.OSM()});
      var style = {
        'Point': new ol.style.Style({
          image: new ol.style.Circle({
            fill: new ol.style.Fill({
              color: 'rgba(255,255,0,0.4)'
            }),
            radius: 5,
            stroke: new ol.style.Stroke({
              color: '#ff0',
              width: 1
            })
          })
        }),
        'LineString': new ol.style.Style({
          stroke: new ol.style.Stroke({
            color: '#f00',
            width: 3
          })
        }),
        'MultiLineString': new ol.style.Style({
          stroke: new ol.style.Stroke({
            color: '#0f0',
            width: 3
          })
        })
      };

      // слой с локального сервера - одна из траекторий(не нужная)
      var vector = new ol.layer.Vector({
        source: new ol.source.Vector({
          url: 'http://localhost:8000/qw.gpx',
          format: new ol.format.GPX()
        }),
        style: function(feature) {
          return style[feature.getGeometry().getType()];
        }
      });

      // ресурс с локального сервера - одна из траекторий(c квадракоптера)
      var vectorSource = new ol.source.Vector({
        url: 'http://localhost:8000/GPXCreator/testGPX.gpx',
        format: new ol.format.GPX()
       });

      // слой с траекторией
      var vector2 = new ol.layer.Vector({
        source: vectorSource,
        style: function(feature) {
          return style[feature.getGeometry().getType()];
        }
      });

      // слой с маркерами
      var markersVector = new ol.layer.Vector({
        source: new ol.source.Vector({
          url: 'http://localhost:8000/GPXCreator/markers.gpx',
          format: new ol.format.GPX()
        }),
        style: function(feature) {
          return style[feature.getGeometry().getType()];
        }
      });

      // карта
      var map = new ol.Map({
        layers: [raster, vector, vector2, markersVector], // загружаем все слои
        target: document.getElementById('map'),
        view: new ol.View({
          center: ol.proj.fromLonLat([30.344354,59.86466]), // центрирование карты
          zoom: 16
        })
      });

      var point = null;   // точка, которая привязывается к траектории
      var line = null;  // линия, которая привязана к точке
      var marker1 = null;
      var marker2 = null;

      const displaySnap = function(coordinate){
        const closestFeature = vectorSource.getClosestFeatureToCoordinate(coordinate);  // выдать объект по ближайшей координате
        if (closestFeature === null) {
          point = null;
          line = null;
        }
        else {
          const geometry = closestFeature.getGeometry();
          const closestPoint = geometry.getClosestPoint(coordinate);
          if (point === null) {   // если точка равна нулю
            point = new ol.geom.Point(closestPoint);  // создать точку
          }
          else {
            point.setCoordinates(closestPoint); // задать точке координаты
          }
          const coordinates = [coordinate, [closestPoint[0], closestPoint[1]]];
          if (line === null) {
            line = new ol.geom.LineString(coordinates); // создаем линию
          }
          else {
            line.setCoordinates(coordinates); // задать линии координаты
          }
        }
        map.render();
      };

      map.on('pointermove', function(evt) {   // событие движения курсора
        if (evt.dragging) {
          return;
        }
        const coordinate = map.getEventCoordinate(evt.originalEvent);
        displaySnap(coordinate);
      });

      map.on('click', function(evt) {  // событие клика на карту
        displaySnap(evt.coordinate);
        /*
        const delta = 10;
        if(point !== null){
          var coordinate = point.getCoordinates();
          if(marker1 !== null)
          {
            var markerCoord = marker1.getCoordinates();
            if((Math.pow(markerCoord[0] - coordinate[0], 2) + Math.pow(markerCoord[1] - coordinate[1], 2)) < delta)
            {
              marker1 = null;
            }
          }
          else
          {
            marker1 = ol.geom.Point(point);
          }
          //var latLon = ol.proj.transform(coordinate, 'EPSG:3857', 'EPSG:4326');
          //document.cookie = "" + latLon;
        } */
      });


      const strokeLine = new ol.style.Stroke({   // стиль линии привязки
        color: 'rgba(0,128,56,0.9)',
        width: 2
      });
      const styleLine = new ol.style.Style({
        stroke: strokeLine,
        image: new ol.style.Circle({
          radius: 5,
          fill: null,
          stroke: strokeLine
        })
      });

      map.on('postcompose', function(evt) {
        const vectorContext = evt.vectorContext;
        vectorContext.setStyle(styleLine);
        if (point !== null) {
          vectorContext.drawGeometry(point);
        }
        if (marker1 !== null){
          vectorContext.drawGeometry(marker1);
        }
        if (line !== null) {
          vectorContext.drawGeometry(line);
        }
      });

    </script>
  </body>
</html>
